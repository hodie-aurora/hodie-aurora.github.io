---
layout:     post   				# 使用的布局（不需要改）
title:      Kubemate 模块速记            		# 标题 
subtitle:   Kubemate 模块速记 				#副标题
date:       2025-06-18				# 时间
author:     zhaohaiwen 				# 作者
header-img: img/post-bg-2025-01-07.jpg		#这篇文章标题背景图片
catalog: true 					# 是否归档
tags:						#标签
    - Kubemate
---
### 模块速记

* **监控与告警**

  **Prometheus：**

  prometheus进行双deploy部署，并且对Prometheus来源打上标签，再通过thanos查询时计算哈希值去重

  thanos sidecar将Prometheus数据持久化道minio中，并且向thanos Querier提供查询接口

  thanos Querier作为查询入口，从thanos获取实时数据和 Store Gateway从 minio获取历史数据，再通过thanos查询时计算哈希值去重

  Thanos Compactor 定期压缩minio中数据，小数据块合并成大块，老数据采样降重，原始数据14天，5分钟数据3个月，1小时数据1年

  指标：延迟、流量、错误、饱和度

  **Alertmanager：**

  Prometheus -> Alertmanager -> 告警api

  评估（收到告警） -> 触发 （告警满足一段时间避免抖动触发 -> 处理（去重、抑制、等待、路由） -> 通知

  去重（防止告警风暴,告警多次发送只处理第一个）

  抑制（配置规则避免升级数据库错误告警）

  等待（等待更多告警加入统一发送避免告警风暴）

  路由（根据对应告警调用API）
* **日志收集与分析**

  存储：promtail (WAL 发送失败记录磁盘，采集、脱敏、解析标签) ->loki Distributor(负载均衡) -> loki Ingester(3多副本写入minio，2确认才成功)

  查询：loki Frontend(读取路径) -> loki Querier(查询minio)

  性能优化：loki Compactor(拆块)

  日志风暴：Promtail设置limit每秒1000行，超出丢弃告警。租户流量超标限制

  高基数：labeldrop丢弃，定时loki api分析

  灾备：检测（巡检）、隔离（隔离特定数据块）、恢复（MinIO纠删码部署抵御小故障，定期异地冷备份抵御大故障）
* **链路追踪**

  速记：

  skywalking： `Java 应用 + SkyWalking Agent` → `SkyWalking OAP(脱敏写入)` → `Storage (Elasticsearch/OpenSearch)` ← `(查询)` → `SkyWalking UI`

  otel+jaeger：`Java 应用 + OTEL Agent` → `OTEL Collector(脱敏导出)`→ `Jaeger Collector(写入)`→`Storage (Elasticsearch/OpenSearch)`←`Jaeger Query `←`Jaeger UI `

  自动埋点为主，手动埋点为辅

  数据保存策略：7天热数据存SSD，14天内存SSD降低刷新频率，大于14天删除索引归档至Minio
* **网关与服务网格**

  * **组成** ：Traefik + Linkerd。
  * **选型理由与优势** ：Traefik 作为网关，其亮点是能够自动发现 Kubernetes 中的服务并更新路由规则，配置简单，性能高。Linkerd 是一个以轻量、安全和高性能著称的服务网格，其 Rust 编写的代理资源消耗极低，运维简单，能快速为应用提供流量加密（mTLS）、重试和可观测性。
  * **横向对比** ：
  * **网关** ：相比于 Nginx Ingress，Traefik 的动态配置和自动化服务发现能力更胜一筹，尤其适合微服务架构。
  * **服务网格** ：相比于功能全面的 Istio，Linkerd 在性能、资源占用和运维复杂度上优势明显，更适合中小型集群或希望快速落地的场景。Istio 功能更强大（如复杂的流量策略），但学习曲线和资源开销也更大。
* **CI/CD**

  * **组成** ：Tekton + Jenkins。
  * **选型理由与优势** ：该方案兼顾了云原生和传统需求。Tekton 是一个完全在 Kubernetes 上运行的云原生 CI/CD 框架，其流水线本身就是 K8s 资源，具备高扩展性和灵活性。同时集成 Jenkins 是为了兼容企业中可能存在的旧有、复杂的流水线任务。
  * **横向对比** ：相比于 GitLab CI 或 GitHub Actions，Tekton 提供了更强的平台中立性，可以与任何 Git 仓库和 K8s 集群集成。而 Jenkins 拥有庞大的插件生态系统，在处理非容器化或复杂的传统构建任务时仍有优势。
* **AI 基础设施**

  * **组成** ：Ollama + Milvus + MLflow 等。
  * **选型理由与优势** ：这是一套为 RAG 和模型微调场景精心挑选的开源工具链。
  * **Ollama** ：极大地简化了大模型的部署和推理，让开发者可以像运行容器一样轻松运行 LLM。
  * **Milvus** ：是业界领先的向量数据库，专为高效的向量相似性搜索设计，是 RAG 应用的核心组件。
  * **MLflow** ：为模型开发提供了实验跟踪、模型打包和注册等关键 MLOps 功能，规范了开发流程。
  * **横向对比** ：
  * **模型服务** ：相比于更复杂的 Triton Inference Server，Ollama 在易用性上优势巨大，非常适合快速开发和部署。
  * **向量数据库** ：相比于 Faiss 这类库，Milvus 提供了完整的服务端解决方案，支持海量数据和高并发查询。相比于 Pinecone 等商业方案，Milvus 是开源的，更利于私有化部署。
  * **实验跟踪** ：相比于 Weights & Biases，MLflow 是开源的，易于和现有技术栈（如 MinIO）集成进行私有化部署。
